<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Tourism Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2e50e8ff 0%, #8017e8ff 100%);
            color: white;
            position: fixed;
            width: 250px;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 15px 20px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4">
            <h4><i class="fas fa-map-marked-alt"></i> Tourism Admin</h4>
            <hr class="bg-white">
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="/admin/dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="/admin/destinations">
                <i class="fas fa-map-pin"></i> Destinations
            </a>
            <a class="nav-link" href="/admin/categories">
                <i class="fas fa-tags"></i> Categories
            </a>
            <a class="nav-link" href="/admin/routes">
                <i class="fas fa-route"></i> Routes
            </a>
            <a class="nav-link" href="/admin/reviews">
                <i class="fas fa-star"></i> Reviews & Feedback
            </a>
            <a class="nav-link active" href="/admin/users">
                <i class="fas fa-users"></i> Users
            </a>
            <hr class="bg-white">
            <a class="nav-link" href="/">
                <i class="fas fa-globe"></i> View Site
            </a>
            <a class="nav-link" href="#" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <h2 class="mb-4"><i class="fas fa-users"></i> Manage Users</h2>

        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> All Users</h5>
                <small>Total: <span id="totalUsers">0</span> users</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border text-primary"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <h5><i class="fas fa-info-circle"></i> User Management Info</h5>
            <ul>
                <li>New users can register from the login page</li>
                <li>You cannot delete or modify your own account from this page</li>
                <li>Admins have access to the admin panel and can manage content</li>
                <li>Regular users can only view the public site and submit reviews/feedback</li>
                <li><strong>Note:</strong> Role management will be available in a future update</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8000/api';
        let currentUserId = null;

        function getToken() {
            return localStorage.getItem('access_token');
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_data');
            window.location.href = '/login';
        }

        async function getCurrentUser() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUserId = user.id;
                    return user;
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
            return null;
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            try {
                // Note: In the current implementation, there's no public endpoint to list all users
                // This would need to be added to the admin router
                // For now, we'll show a message
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-info-circle fa-3x text-info mb-3 d-block"></i>
                            <h5>User Management Endpoint Not Yet Implemented</h5>
                            <p class="text-muted">
                                To enable user management, add the following endpoint to your FastAPI admin router:
                            </p>
                            <div class="text-start" style="max-width: 600px; margin: 0 auto;">
                                <pre class="bg-light p-3 rounded"><code>@router.get("/users")
def get_all_users(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_admin)
):
    users = db.query(User).order_by(User.created_at.desc()).all()
    return users</code></pre>
                            </div>
                            <p class="mt-3">
                                <strong>Current Implementation Status:</strong><br>
                                ✅ User registration and authentication working<br>
                                ✅ Role-based access control working<br>
                                ⏳ User listing endpoint (needs to be added)<br>
                                ⏳ User role modification (needs to be added)<br>
                                ⏳ User deletion (needs to be added)
                            </p>
                        </td>
                    </tr>
                `;

                document.getElementById('totalUsers').textContent = 'N/A';

                // Alternative: Try to load users if endpoint exists
                /* Uncomment when endpoint is ready:
                const response = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (response.ok) {
                    const users = await response.json();
                    
                    document.getElementById('totalUsers').textContent = users.length;

                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>
                                <strong>${user.username}</strong>
                                ${user.id === currentUserId ? '<span class="badge bg-info ms-2">You</span>' : ''}
                            </td>
                            <td>${user.email || '<span class="text-muted">No email</span>'}</td>
                            <td>
                                ${user.role === 'admin' ? 
                                    '<span class="badge bg-danger"><i class="fas fa-shield-alt"></i> Admin</span>' : 
                                    '<span class="badge bg-secondary"><i class="fas fa-user"></i> User</span>'}
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                ${user.id !== currentUserId ? 
                                    `<button class="btn btn-sm btn-warning" onclick="toggleRole(${user.id})" title="Toggle Role">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Delete User">
                                        <i class="fas fa-trash"></i>
                                    </button>` : 
                                    '<span class="text-muted"><i class="fas fa-lock"></i> Protected</span>'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    throw new Error('Users endpoint not available');
                }
                */
            } catch (error) {
                console.error('Error loading users:', error);
                // Error is already shown in the default message above
            }
        }

        async function toggleRole(userId) {
            if (!confirm('Change this user\'s role?')) return;

            try {
                // This endpoint would also need to be added
                const response = await fetch(`${API_URL}/admin/users/${userId}/toggle-role`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (response.ok) {
                    alert('User role updated successfully!');
                    loadUsers();
                } else {
                    alert('Error updating user role');
                }
            } catch (error) {
                console.error('Error toggling role:', error);
                alert('Error updating user role');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            try {
                // This endpoint would also need to be added
                const response = await fetch(`${API_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                } else {
                    alert('Error deleting user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!getToken()) {
                window.location.href = '/login';
                return;
            }
            await getCurrentUser();
            loadUsers();
        });
    </script>
</body>
</html>