{% extends "admin/base.html" %}

{% block title %}Manage Destinations{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-map-pin"></i> Manage Destinations</h2>
        <a href="/admin/destinations/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add New Destination
        </a>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

<!-- Search and Filter -->
 <div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="Search destinations..." 
                       onkeyup="filterDestinations()">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter" onchange="filterDestinations()">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter" onchange="filterDestinations()">
                    <option value="all">All Status</option>
                    <option value="active" selected>Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" onclick="filterDestinations()">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Destinations Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="destinationsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-2">Loading destinations...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allDestinations = [];
    let categories = [];
    
async function loadAllData() {
    try {
        showLoading();
        
        // âœ… Load ALL destinations (active and inactive)
        const destResponse = await fetch('/api/destinations/?page_size=100&is_active=true');
        const activeData = await destResponse.json();
        
        const inactiveResponse = await fetch('/api/destinations/?page_size=100&is_active=false');
        const inactiveData = await inactiveResponse.json();
        
        // Combine both
        allDestinations = [...activeData.destinations, ...inactiveData.destinations];
        
        // Load categories
        const catResponse = await fetch('/api/categories/');
        categories = await catResponse.json();
        
        populateCategoryFilter();
        filterDestinations(); // Apply initial filter
        
    } catch (error) {
        console.error('Error loading data:', error);
        showAlert('error', 'Error loading destinations. Please refresh the page.');
    } finally {
        hideLoading();
    }
}    
    // Populate category filter
    function populateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }
    
    // Display destinations
    function displayDestinations(destinations) {
        const tbody = document.querySelector('#destinationsTable tbody');
        
        if (!destinations || destinations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                        <p>No destinations found</p>
                        <a href="/admin/destinations/add" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Your First Destination
                        </a>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = destinations.map(dest => {
            const imageUrl = dest.image_path 
                ? `/uploads/${dest.image_path}` 
                : 'https://via.placeholder.com/80x60?text=' + encodeURIComponent(dest.name);
            
            const coords = dest.latitude && dest.longitude
                ? `${parseFloat(dest.latitude).toFixed(4)}, ${parseFloat(dest.longitude).toFixed(4)}`
                : '<span class="text-muted">No coordinates</span>';
            
            return `
                <tr data-id="${dest.id}">
                    <td>
                        <img src="${imageUrl}" alt="${dest.name}" 
                             class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                    </td>
                    <td><strong>${dest.name}</strong></td>
                    <td>
                        <span class="badge bg-secondary">
                            <i class="fas ${dest.category_icon || 'fa-tag'}"></i>
                            ${dest.category_name || 'Uncategorized'}
                        </span>
                    </td>
                    <td><small>${coords}</small></td>
                    <td>
                        ${dest.is_active 
                            ? '<span class="badge bg-success">Active</span>' 
                            : '<span class="badge bg-danger">Inactive</span>'
                        }
                    </td>
                    <td><small>${formatDate(dest.created_at)}</small></td>
                    <td class="table-actions">
                        <div class="btn-group" role="group">
                            <a href="/admin/destinations/edit/${dest.id}" 
                               class="btn btn-sm btn-primary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="/destination/${dest.id}" 
                               class="btn btn-sm btn-info" title="View" target="_blank">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button onclick="toggleStatus(${dest.id}, ${dest.is_active})" 
                                    class="btn btn-sm btn-warning" title="Toggle Status">
                                <i class="fas fa-toggle-on"></i>
                            </button>
                            <button onclick="deleteDestination(${dest.id}, '${dest.name.replace(/'/g, "\\'")}')" 
                                    class="btn btn-sm btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Filter destinations
    function filterDestinations() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryId = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        const filtered = allDestinations.filter(dest => {
            const matchSearch = !searchTerm || 
                dest.name.toLowerCase().includes(searchTerm) ||
                (dest.description && dest.description.toLowerCase().includes(searchTerm));
            
            const matchCategory = !categoryId || dest.category_id == categoryId;
            
            const matchStatus = !status || 
                (status === 'active' && dest.is_active) ||
                (status === 'inactive' && !dest.is_active);
            
            return matchSearch && matchCategory && matchStatus;
        });
        
        displayDestinations(filtered);
    }
    
    // Toggle destination status
    async function toggleStatus(id, currentStatus) {
        if (!confirmDelete(`Toggle status to ${currentStatus ? 'Inactive' : 'Active'}?`)) {
            return;
        }
        
        try {
            showLoading();
            
            const response = await fetch(`/api/admin/destinations/${id}/toggle`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to toggle status');
            }
            
            showAlert('success', 'Status updated successfully!');
            loadAllData();
            
        } catch (error) {
            console.error('Error toggling status:', error);
            showAlert('error', 'Error updating status. Please try again.');
        } finally {
            hideLoading();
        }
    }
    
    // Delete destination
    async function deleteDestination(id, name) {
        if (!confirmDelete(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            showLoading();
            
            const response = await fetch(`/api/admin/destinations/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete destination');
            }
            
            showAlert('success', 'Destination deleted successfully!');
            loadAllData();
            
        } catch (error) {
            console.error('Error deleting destination:', error);
            showAlert('error', 'Error deleting destination. Please try again.');
        } finally {
            hideLoading();
        }
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
{% endblock %}