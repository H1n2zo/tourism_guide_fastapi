<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin Panel{% endblock %} - Tourism Guide</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2e50e8ff 0%, #8017e8ff 100%);
            color: white;
            position: fixed;
            width: 250px;
            top: 0;
            left: 0;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 15px 20px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: white;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .stat-card {
            border-left: 4px solid;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.primary { border-color: #667eea; }
        .stat-card.success { border-color: #28a745; }
        .stat-card.warning { border-color: #ffc107; }
        .stat-card.info { border-color: #17a2b8; }
        .stat-card.danger { border-color: #dc3545; }
        
        .badge-new {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        #loadingOverlay.show {
            display: flex;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-light" role="status"></div>
            <p class="text-light mt-3">Loading...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4">
            <h4><i class="fas fa-map-marked-alt"></i> Tourism Admin</h4>
            <hr class="bg-white">
            <p class="small mb-0">Welcome, <strong id="adminUsername">Admin</strong></p>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link" href="/admin/dashboard" id="nav-dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="/admin/destinations" id="nav-destinations">
                <i class="fas fa-map-pin"></i> Destinations
            </a>
            <a class="nav-link" href="/admin/categories" id="nav-categories">
                <i class="fas fa-tags"></i> Categories
            </a>
            <a class="nav-link" href="/admin/routes" id="nav-routes">
                <i class="fas fa-route"></i> Routes
            </a>
            <a class="nav-link" href="/admin/reviews" id="nav-reviews">
                <i class="fas fa-star"></i> Reviews & Feedback
                <span class="badge bg-danger ms-2" id="unreadBadge" style="display:none;"></span>
            </a>
            <a class="nav-link" href="/admin/users" id="nav-users">
                <i class="fas fa-users"></i> Users
            </a>
            <hr class="bg-white">
            <a class="nav-link" href="/" target="_blank">
                <i class="fas fa-globe"></i> View Site
            </a>
            <a class="nav-link" href="/logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/js/auth.js"></script>
    
    <script>
        // Check admin access
        document.addEventListener('DOMContentLoaded', async function() {
            const response = await fetch('/api/auth/check-session');
            const data = await response.json();
            
            if (!data.logged_in || data.role !== 'admin') {
                window.location.href = '/login';
                return;
            }
            
            document.getElementById('adminUsername').textContent = data.username;
            
            // Highlight active nav
            const currentPath = window.location.pathname;
            const navId = 'nav-' + currentPath.split('/').pop();
            const activeNav = document.getElementById(navId);
            if (activeNav) {
                activeNav.classList.add('active');
            }
            
            // Load unread count
            loadUnreadCount();
        });
        
        // Load unread feedback count
        async function loadUnreadCount() {
            try {
                const response = await fetch('/api/admin/dashboard/stats', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.unread_feedback > 0) {
                    const badge = document.getElementById('unreadBadge');
                    badge.textContent = data.unread_feedback;
                    badge.style.display = 'inline';
                }
            } catch (error) {
                console.error('Error loading unread count:', error);
            }
        }
        
        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        // Show alert message
        function showAlert(type, message, containerId = 'alertContainer') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
            
            container.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show">
                    <i class="fas fa-${icon}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.scrollIntoView({ behavior: 'smooth' });
            
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Confirm delete
        function confirmDelete(message = 'Are you sure you want to delete this item?') {
            return confirm(message);
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Format datetime
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>