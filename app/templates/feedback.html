{% extends "base.html" %}

{% block title %}Feedback - Tourism Guide System{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #132365ff 0%, #4b59a3ff 100%);
        color: white;
        padding: 60px 0 80px;
    }
    .feedback-card {
        transition: transform 0.3s;
        border-left: 4px solid #667eea;
    }
    .feedback-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .rating {
        color: #ffc107;
    }
    .star-rating {
        direction: rtl;
        display: inline-flex;
        font-size: 2.5rem;
    }
    .star-rating input[type="radio"] {
        display: none;
    }
    .star-rating label {
        color: #ddd;
        cursor: pointer;
        padding: 0 10px;
    }
    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input[type="radio"]:checked ~ label {
        color: #ffc107;
    }
    .form-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-top: -50px;
        position: relative;
        z-index: 10;
        padding: 30px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" style="margin-top: -100px;">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-3">We Value Your Feedback</h1>
        <p class="lead">Help us improve the Ormoc Tourism Guide System</p>
        <div class="rating mt-3" id="overallRatingContainer" style="font-size: 1.5rem;">
            Loading...
        </div>
    </div>
</section>

<!-- Feedback Form -->
<div class="container">
    <div class="form-section">
        <div id="alertContainer"></div>

        <h3 class="mb-4"><i class="fas fa-star"></i> Rate Our Tourism Guide</h3>
        
        <form id="feedbackForm" onsubmit="submitFeedback(event)">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-control" id="user_name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email (Optional)</label>
                    <input type="email" class="form-control" id="email">
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Rate the Tourism Guide System *</label>
                <div class="text-center">
                    <div class="star-rating">
                        <input type="radio" name="rating" value="5" id="rating5" required>
                        <label for="rating5"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="4" id="rating4">
                        <label for="rating4"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="3" id="rating3">
                        <label for="rating3"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="2" id="rating2">
                        <label for="rating2"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="1" id="rating1">
                        <label for="rating1"><i class="fas fa-star"></i></label>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Click on a star to rate</small>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Feedback Category *</label>
                <select class="form-select" id="category" required>
                    <option value="general">General Feedback</option>
                    <option value="usability">Usability & Navigation</option>
                    <option value="features">Features & Functionality</option>
                    <option value="content">Content & Information</option>
                    <option value="design">Design & Interface</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Your Feedback *</label>
                <textarea class="form-control" id="feedback" rows="5" 
                          placeholder="Tell us what you think about our tourism guide system..." 
                          required minlength="10"></textarea>
                <small class="text-muted">Share your experience, suggestions, or report any issues.</small>
            </div>

            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane"></i> Submit Feedback
            </button>
        </form>
    </div>
</div>

<!-- Recent Feedback -->
<div class="container mt-5 mb-5">
    <h3 class="mb-4"><i class="fas fa-comments"></i> Recent Feedback from Visitors</h3>
    
    <div class="row" id="feedbackContainer">
        <div class="col-12 text-center">
            <p class="text-muted">Loading feedback...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load overall rating stats
async function loadStats() {
    try {
        const response = await fetch('/api/feedback/stats');
        const stats = await response.json();
        
        const container = document.getElementById('overallRatingContainer');
        
        if (stats.total_feedback > 0 && stats.average_rating) {
            const avg = stats.average_rating;
            container.innerHTML = `
                Overall Rating: 
                ${'★'.repeat(Math.round(avg))}${'☆'.repeat(5 - Math.round(avg))}
                <span class="ms-2">${avg.toFixed(1)} / 5</span>
                <span class="ms-2">(${stats.total_feedback} ratings)</span>
            `;
        } else {
            container.innerHTML = 'No ratings yet. Be the first to rate!';
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load public feedback
async function loadFeedback() {
    try {
        const response = await fetch('/api/feedback/public');
        const feedbacks = await response.json();
        
        const container = document.getElementById('feedbackContainer');
        
        if (feedbacks.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> No feedback yet. Be the first to share your thoughts!
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = feedbacks.map(fb => `
            <div class="col-md-6 mb-4">
                <div class="card feedback-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="card-title mb-0">${fb.user_name}</h5>
                            <span class="badge bg-secondary">${fb.category.charAt(0).toUpperCase() + fb.category.slice(1)}</span>
                        </div>
                        <div class="rating mb-2">
                            ${'★'.repeat(fb.rating)}${'☆'.repeat(5 - fb.rating)}
                        </div>
                        <p class="card-text">${fb.feedback}</p>
                        <small class="text-muted">
                            <i class="far fa-clock"></i> ${new Date(fb.created_at).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading feedback:', error);
        document.getElementById('feedbackContainer').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading feedback. Please try again later.
                </div>
            </div>
        `;
    }
}

// Submit feedback
async function submitFeedback(event) {
    event.preventDefault();
    
    const feedbackData = {
        user_name: document.getElementById('user_name').value,
        email: document.getElementById('email').value || null,
        rating: parseInt(document.querySelector('input[name="rating"]:checked').value),
        category: document.getElementById('category').value,
        feedback: document.getElementById('feedback').value
    };
    
    try {
        const response = await fetch('/api/feedback/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(feedbackData)
        });
        
        if (response.ok) {
            showAlert('success', 'Thank you for your feedback! We appreciate your input.');
            document.getElementById('feedbackForm').reset();
            loadFeedback();
            loadStats();
        } else {
            const error = await response.json();
            showAlert('danger', 'Error submitting feedback: ' + (error.detail || 'Please try again.'));
        }
    } catch (error) {
        console.error('Error submitting feedback:', error);
        showAlert('danger', 'Error submitting feedback. Please try again.');
    }
}

// Show alert
function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Scroll to alert
    alertContainer.scrollIntoView({ behavior: 'smooth' });
}

// Load on page ready
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadFeedback();
});
</script>
{% endblock %}