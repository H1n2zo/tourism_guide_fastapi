{% extends "base.html" %}

{% block title %}Feedback - Tourism Guide{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #132365ff 0%, #4b59a3ff 100%);
        color: white;
        padding: 60px 0 80px;
        margin-top: -50px;
    }
    
    .form-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-top: -50px;
        position: relative;
        z-index: 10;
        padding: 30px;
    }
    
    .star-rating {
        direction: rtl;
        display: inline-flex;
        font-size: 2.5rem;
    }
    
    .star-rating input[type="radio"] {
        display: none;
    }
    
    .star-rating label {
        color: #ddd;
        cursor: pointer;
        padding: 0 10px;
    }
    
    .star-rating label:hover,
    .star-rating label:hover ~ label,
    .star-rating input[type="radio"]:checked ~ label {
        color: #ffc107;
    }
    
    .feedback-card {
        transition: transform 0.3s;
        border-left: 4px solid #667eea;
    }
    
    .feedback-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .rating {
        color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container text-center">
        <h1 class="display-4 fw-bold mb-3">We Value Your Feedback</h1>
        <p class="lead">Help us improve the Tourism Guide System</p>
        <div class="mt-3" id="overallRating">
            <div class="rating" style="font-size: 1.5rem;">
                <span id="avgRating">Loading...</span>
            </div>
        </div>
    </div>
</section>

<!-- Feedback Form -->
<div class="container">
    <div class="form-section">
        <h3 class="mb-4"><i class="fas fa-star"></i> Rate Our Tourism Guide</h3>
        
        <form id="feedbackForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-control" id="userName" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email (Optional)</label>
                    <input type="email" class="form-control" id="userEmail">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="form-label">Rate the Tourism Guide System *</label>
                <div class="text-center">
                    <div class="star-rating">
                        <input type="radio" name="rating" value="5" id="rating5" required>
                        <label for="rating5"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="4" id="rating4" required>
                        <label for="rating4"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="3" id="rating3" required>
                        <label for="rating3"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="2" id="rating2" required>
                        <label for="rating2"><i class="fas fa-star"></i></label>
                        <input type="radio" name="rating" value="1" id="rating1" required>
                        <label for="rating1"><i class="fas fa-star"></i></label>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Click on a star to rate</small>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Feedback Category *</label>
                <select class="form-select" id="category" required>
                    <option value="general">General Feedback</option>
                    <option value="usability">Usability & Navigation</option>
                    <option value="features">Features & Functionality</option>
                    <option value="content">Content & Information</option>
                    <option value="design">Design & Interface</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Your Feedback *</label>
                <textarea class="form-control" id="feedback" rows="5" 
                          placeholder="Tell us what you think about our tourism guide system..." 
                          required minlength="10"></textarea>
                <small class="text-muted">Share your experience, suggestions, or report any issues. (Minimum 10 characters)</small>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane"></i> Submit Feedback
            </button>
        </form>
    </div>
</div>

<!-- Recent Feedback -->
<div class="container mt-5 mb-5">
    <h3 class="mb-4"><i class="fas fa-comments"></i> Recent Feedback from Visitors</h3>
    
    <div class="row" id="feedbackList">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load feedback statistics
async function loadStatistics() {
    try {
        const response = await fetch(`${API_URL}/feedback/statistics`);
        const stats = await response.json();
        
        if (stats.average_rating > 0) {
            const stars = '★'.repeat(Math.round(stats.average_rating)) + '☆'.repeat(5 - Math.round(stats.average_rating));
            document.getElementById('avgRating').innerHTML = `
                Overall Rating: ${stars} ${stats.average_rating} / 5
                <span class="ms-2">(${stats.total_feedback} ratings)</span>
            `;
        } else {
            document.getElementById('avgRating').textContent = 'No ratings yet';
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Load public feedback
async function loadFeedback() {
    try {
        const response = await fetch(`${API_URL}/feedback/public`);
        const feedbacks = await response.json();
        
        const feedbackList = document.getElementById('feedbackList');
        
        if (feedbacks.length === 0) {
            feedbackList.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle"></i> No feedback yet. Be the first to share your thoughts!
                    </div>
                </div>
            `;
            return;
        }
        
        feedbackList.innerHTML = feedbacks.map(fb => `
            <div class="col-md-6 mb-4">
                <div class="card feedback-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="card-title mb-0">${fb.user_name}</h5>
                            <span class="badge bg-secondary">${fb.category}</span>
                        </div>
                        <div class="rating mb-2">
                            ${'★'.repeat(fb.rating)}${'☆'.repeat(5-fb.rating)}
                        </div>
                        <p class="card-text">${fb.feedback}</p>
                        <small class="text-muted">
                            <i class="far fa-clock"></i> ${new Date(fb.created_at).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading feedback:', error);
    }
}

// Handle form submission
document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const rating = document.querySelector('input[name="rating"]:checked');
    if (!rating) {
        showAlert('Please select a rating', 'warning');
        return;
    }
    
    const feedbackData = {
        user_name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value || null,
        rating: parseInt(rating.value),
        category: document.getElementById('category').value,
        feedback: document.getElementById('feedback').value
    };
    
    try {
        const response = await fetch(`${API_URL}/feedback/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(getToken() ? {'Authorization': `Bearer ${getToken()}`} : {})
            },
            body: JSON.stringify(feedbackData)
        });
        
        if (response.ok) {
            showAlert('Thank you for your feedback! We appreciate your input.', 'success');
            document.getElementById('feedbackForm').reset();
            loadFeedback();
            loadStatistics();
        } else {
            showAlert('Error submitting feedback. Please try again.', 'danger');
        }
    } catch (error) {
        console.error('Error submitting feedback:', error);
        showAlert('Error submitting feedback. Please try again.', 'danger');
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
    loadFeedback();
    
    // Pre-fill name if logged in
    if (isAuthenticated()) {
        const userData = localStorage.getItem('user_data');
        if (userData) {
            const user = JSON.parse(userData);
            document.getElementById('userName').value = user.username;
            if (user.email) {
                document.getElementById('userEmail').value = user.email;
            }
        }
    }
});
</script>
{% endblock %}