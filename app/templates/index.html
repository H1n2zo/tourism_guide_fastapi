{% extends "base.html" %}

{% block title %}Home - Tourism Guide System{% endblock %}

{% block extra_css %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #132365ff 0%, #4b59a3ff 100%);
        color: white;
        padding: 80px 0;
        margin-top: -50px;
        margin-bottom: 30px;
    }
    
    .stats-row {
        display: flex;
        justify-content: center;
        gap: 50px;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .stat-item {
        text-align: center;
        background: rgba(255,255,255,0.1);
        padding: 20px 40px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        transition: transform 0.3s;
    }
    
    .stat-item:hover {
        transform: translateY(-5px);
    }
    
    .stat-item h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .search-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-top: -50px;
        position: relative;
        z-index: 10;
    }
    
    .destination-card {
        transition: transform 0.3s, box-shadow 0.3s;
        height: 100%;
        border: none;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .destination-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .destination-card img {
        height: 200px;
        object-fit: cover;
    }
    
    .category-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.9);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    
    .rating {
        color: #ffc107;
        font-size: 0.95rem;
    }
    
    #map {
        height: 600px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .route-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .route-card:hover {
        border-color: #132365ff;
        box-shadow: 0 5px 15px rgba(19, 35, 101, 0.2);
    }
    
    .route-card.selected {
        border-color: #132365ff;
        background: rgba(19, 35, 101, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" id="home">
    <div class="container text-center">
        <h1 class="display-3 fw-bold mb-3">Discover Amazing Places</h1>
        <p class="lead mb-4">Explore tourist destinations, find routes, and plan your journey</p>
        <a href="#destinations" class="btn btn-light btn-lg">
            <i class="fas fa-compass"></i> Start Exploring
        </a>
        
        <!-- Statistics -->
        <div class="stats-row" id="statsRow">
            <div class="stat-item">
                <h3 id="totalDestinations">0</h3>
                <p>Destinations</p>
            </div>
            <div class="stat-item">
                <h3 id="totalReviews">0</h3>
                <p>Reviews</p>
            </div>
            <div class="stat-item">
                <h3 id="totalCategories">0</h3>
                <p>Categories</p>
            </div>
        </div>
    </div>
</section>

<!-- Search and Filter -->
<div class="container">
    <div class="search-box">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search destinations...">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" onclick="loadDestinations()">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Destinations Grid -->
<div class="container mt-5" id="destinations">
    <h2 class="mb-4"><i class="fas fa-map-pin"></i> Featured Destinations</h2>
    <div class="row g-4" id="destinationsGrid">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Map Section -->
<div class="container mt-5" id="routes">
    <h2 class="mb-4"><i class="fas fa-map"></i> Interactive Map & Route Finder</h2>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="mb-3"><i class="fas fa-filter"></i> Filter Routes</h5>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Filter by Transport</label>
                    <select class="form-select" id="filterTransport" onchange="loadRoutes()">
                        <option value="">All Transport Modes</option>
                        <option value="jeepney">Jeepney</option>
                        <option value="taxi">Taxi</option>
                        <option value="bus">Bus</option>
                        <option value="van">Van</option>
                        <option value="tricycle">Tricycle</option>
                        <option value="walking">Walking</option>
                    </select>
                </div>
            </div>
            
            <hr class="my-4">
            
            <h5 class="mb-4"><i class="fas fa-route"></i> Available Routes</h5>
            <div id="routesContainer">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, allDestinations = [], allRoutes = [];

// Load statistics
async function loadStatistics() {
    try {
        const response = await fetch(`${API_URL}/destinations/statistics/summary`);
        const stats = await response.json();
        
        document.getElementById('totalDestinations').textContent = stats.total_destinations;
        document.getElementById('totalReviews').textContent = stats.total_reviews;
        document.getElementById('totalCategories').textContent = stats.total_categories;
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Load categories
async function loadCategories() {
    try {
        const response = await fetch(`${API_URL}/destinations/categories`);
        const categories = await response.json();
        
        const select = document.getElementById('categoryFilter');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load destinations
async function loadDestinations() {
    const grid = document.getElementById('destinationsGrid');
    grid.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        
        let url = `${API_URL}/destinations/?`;
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (category) url += `category_id=${category}&`;
        
        const response = await fetch(url);
        allDestinations = await response.json();
        
        if (allDestinations.length === 0) {
            grid.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h3>No destinations found</h3>
                    <p class="text-muted">Try adjusting your search or filter criteria</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = allDestinations.map(dest => `
            <div class="col-md-4">
                <div class="card destination-card">
                    <div class="position-relative">
                        <img src="${dest.image_path ? '/uploads/' + dest.image_path : 'https://via.placeholder.com/400x300'}" 
                             class="card-img-top" alt="${dest.name}">
                        <span class="category-badge">
                            <i class="fas ${dest.category_icon || 'fa-map-pin'}"></i> ${dest.category_name || 'Uncategorized'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${dest.name}</h5>
                        <p class="card-text">${dest.description ? dest.description.substring(0, 100) + '...' : ''}</p>
                        <div class="mb-2">
                            ${dest.review_count > 0 ? `
                                <div class="rating">
                                    ${'★'.repeat(Math.round(dest.avg_rating))}${'☆'.repeat(5 - Math.round(dest.avg_rating))}
                                </div>
                                <small class="text-muted">
                                    ${dest.avg_rating.toFixed(1)} / 5 (${dest.review_count} review${dest.review_count !== 1 ? 's' : ''})
                                </small>
                            ` : '<small class="text-muted"><i>Not rated yet</i></small>'}
                        </div>
                        <a href="/destination/${dest.id}" class="btn btn-primary btn-sm">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                        ${dest.latitude && dest.longitude ? `
                            <button class="btn btn-outline-primary btn-sm" onclick="showOnMap(${dest.latitude}, ${dest.longitude})">
                                <i class="fas fa-map-marker-alt"></i> Show on Map
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        // Initialize map with destinations
        initializeMap();
    } catch (error) {
        console.error('Error loading destinations:', error);
        grid.innerHTML = '<div class="col-12 text-center text-danger">Error loading destinations</div>';
    }
}

// Load routes
async function loadRoutes() {
    const container = document.getElementById('routesContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const transport = document.getElementById('filterTransport').value;
        let url = `${API_URL}/routes/?`;
        if (transport) url += `transport_mode=${transport}&`;
        
        const response = await fetch(url);
        allRoutes = await response.json();
        
        if (allRoutes.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-route fa-3x text-muted mb-3"></i>
                    <h5>No Routes Available</h5>
                    <p>Routes will be displayed here once added to the system.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = allRoutes.map(route => `
            <div class="route-card" onclick="selectRoute(${route.id})">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${route.route_name || (route.origin_name + ' to ' + route.destination_name)}</h6>
                    <span class="badge bg-info">${route.transport_mode}</span>
                </div>
                <div class="text-muted mb-2">
                    <i class="fas fa-map-marker-alt"></i> ${route.origin_name} 
                    <i class="fas fa-arrow-right mx-2"></i> 
                    ${route.destination_name}
                </div>
                <div class="row">
                    ${route.distance_km ? `
                        <div class="col-md-4">
                            <small class="text-muted">Distance:</small>
                            <strong>${route.distance_km} km</strong>
                        </div>
                    ` : ''}
                    ${route.estimated_time_minutes ? `
                        <div class="col-md-4">
                            <small class="text-muted">Duration:</small>
                            <strong>${route.estimated_time_minutes} min</strong>
                        </div>
                    ` : ''}
                    ${route.total_fare > 0 ? `
                        <div class="col-md-4">
                            <small class="text-muted">Fare:</small>
                            <strong>₱${route.total_fare.toFixed(2)}</strong>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading routes:', error);
        container.innerHTML = '<div class="text-center text-danger">Error loading routes</div>';
    }
}

// Initialize map
function initializeMap() {
    if (!map) {
        map = L.map('map').setView([11.0059, 124.6075], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
    }
    
    // Add destination markers
    allDestinations.forEach(dest => {
        if (dest.latitude && dest.longitude) {
            const marker = L.marker([parseFloat(dest.latitude), parseFloat(dest.longitude)]).addTo(map);
            
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    ${dest.image_path ? `<img src="/uploads/${dest.image_path}" style="width:100%;height:120px;object-fit:cover;border-radius:5px;margin-bottom:8px;">` : ''}
                    <h6>${dest.name}</h6>
                    <p><i class="fas ${dest.category_icon}"></i> ${dest.category_name}</p>
                    ${dest.review_count > 0 ? `
                        <div style="color: #ffc107;">
                            ${'★'.repeat(Math.round(dest.avg_rating))}${'☆'.repeat(5-Math.round(dest.avg_rating))}
                            <small>${dest.avg_rating} (${dest.review_count})</small>
                        </div>
                    ` : ''}
                    <a href="/destination/${dest.id}" class="btn btn-sm btn-primary mt-2">View Details</a>
                </div>
            `);
        }
    });
}

function showOnMap(lat, lng) {
    map.setView([parseFloat(lat), parseFloat(lng)], 15);
    document.getElementById('routes').scrollIntoView({behavior: 'smooth'});
}

function selectRoute(routeId) {
    const route = allRoutes.find(r => r.id === routeId);
    if (!route) return;
    
    // Highlight selected card
    document.querySelectorAll('.route-card').forEach(card => card.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    
    // Draw route on map
    if (route.origin_lat && route.origin_lng && route.dest_lat && route.dest_lng) {
        const line = L.polyline([
            [route.origin_lat, route.origin_lng],
            [route.dest_lat, route.dest_lng]
        ], {color: '#ffc107', weight: 6, opacity: 0.8}).addTo(map);
        
        map.fitBounds(line.getBounds(), {padding: [50, 50]});
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
    loadCategories();
    loadDestinations();
    loadRoutes();
});
</script>
{% endblock %}